openapi: 3.1.0
info:
  title: Hypeman API
  description: Generic API for managing VM lifecycle using Cloud Hypervisor with OCI-based workloads
  version: 0.2.0
servers:
  - url: http://localhost:8080
    description: Local development server
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
  schemas:
    ErrorDetail:
      type: object
      properties:
        code:
          type: string
          description: Lower-level error code providing more specific detail
          example: invalid_input
        message:
          type: string
          description: Further detail about the error
          example: Image not found
    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          description: Application-specific error code (machine-readable)
          example: bad_request
        message:
          type: string
          description: Human-readable error description for debugging
          example: "Missing required field: image"
        details:
          type: array
          description: Additional error details (for multiple errors)
          items:
            $ref: "#/components/schemas/ErrorDetail"
        inner_error:
          $ref: "#/components/schemas/ErrorDetail"
    
    InstanceState:
      type: string
      enum: [Created, Running, Paused, Shutdown, Stopped, Standby, Unknown]
      description: |
        Instance state:
        - Created: VMM created but not started (Cloud Hypervisor native)
        - Running: VM is actively running (Cloud Hypervisor native)
        - Paused: VM is paused (Cloud Hypervisor native)
        - Shutdown: VM shut down but VMM exists (Cloud Hypervisor native)
        - Stopped: No VMM running, no snapshot exists
        - Standby: No VMM running, snapshot exists (can be restored)
        - Unknown: Failed to determine state (see state_error for details)
    
    VolumeMount:
      type: object
      required: [volume_id, mount_path]
      properties:
        volume_id:
          type: string
          description: Volume identifier
          example: vol-abc123
        mount_path:
          type: string
          description: Path where volume is mounted in the guest
          example: /mnt/data
        readonly:
          type: boolean
          description: Whether volume is mounted read-only
          default: false
        overlay:
          type: boolean
          description: Create per-instance overlay for writes (requires readonly=true)
          default: false
        overlay_size:
          type: string
          description: Max overlay size as human-readable string (e.g., "1GB"). Required if overlay=true.
          example: "1GB"
    
    PortMapping:
      type: object
      required: [host_port, guest_port]
      properties:
        host_port:
          type: integer
          description: Port on the host
          example: 8080
        guest_port:
          type: integer
          description: Port in the guest VM
          example: 80
        protocol:
          type: string
          enum: [tcp, udp]
          default: tcp
    
    CreateInstanceRequest:
      type: object
      required: [name, image]
      properties:
        name:
          type: string
          description: Human-readable name (lowercase letters, digits, and dashes only; cannot start or end with a dash)
          pattern: ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$
          maxLength: 63
          example: my-workload-1
        image:
          type: string
          description: OCI image reference
          example: docker.io/library/alpine:latest
        size:
          type: string
          description: Base memory size (human-readable format like "1GB", "512MB", "2G")
          default: "1GB"
          example: "2GB"
        hotplug_size:
          type: string
          description: Additional memory for hotplug (human-readable format like "3GB", "1G")
          default: "3GB"
          example: "2GB"
        overlay_size:
          type: string
          description: Writable overlay disk size (human-readable format like "10GB", "50G")
          default: "10GB"
          example: "20GB"
        vcpus:
          type: integer
          description: Number of virtual CPUs
          default: 2
          example: 2
        env:
          type: object
          additionalProperties:
            type: string
          description: Environment variables
          example:
            PORT: "3000"
            NODE_ENV: production
        network:
          type: object
          description: Network configuration for the instance
          properties:
            enabled:
              type: boolean
              description: Whether to attach instance to the default network
              default: true
              example: true
        devices:
          type: array
          items:
            type: string
          description: Device IDs or names to attach for GPU/PCI passthrough
          example: ["l4-gpu"]
        volumes:
          type: array
          description: Volumes to attach to the instance at creation time
          items:
            $ref: "#/components/schemas/VolumeMount"
        # Future: port_mappings, timeout_seconds
    
    Instance:
      type: object
      required: [id, name, image, state, created_at]
      properties:
        id:
          type: string
          description: Auto-generated unique identifier (CUID2 format)
          example: tz4a98xxat96iws9zmbrgj3a
        name:
          type: string
          description: Human-readable name
          example: my-workload-1
        image:
          type: string
          description: OCI image reference
          example: docker.io/library/alpine:latest
        state:
          $ref: "#/components/schemas/InstanceState"
        state_error:
          type: string
          description: Error message if state couldn't be determined (only set when state is Unknown)
          nullable: true
          example: "failed to query VMM: connection refused"
        size:
          type: string
          description: Base memory size (human-readable)
          example: "2GB"
        hotplug_size:
          type: string
          description: Hotplug memory size (human-readable)
          example: "2GB"
        overlay_size:
          type: string
          description: Writable overlay disk size (human-readable)
          example: "10GB"
        vcpus:
          type: integer
          description: Number of virtual CPUs
          example: 2
        env:
          type: object
          additionalProperties:
            type: string
          description: Environment variables
        network:
          type: object
          description: Network configuration of the instance
          properties:
            enabled:
              type: boolean
              description: Whether instance is attached to the default network
              example: true
            name:
              type: string
              description: Network name (always "default" when enabled)
              example: "default"
            ip:
              type: string
              description: Assigned IP address (null if no network)
              example: "192.168.100.10"
              nullable: true
            mac:
              type: string
              description: Assigned MAC address (null if no network)
              example: "02:00:00:ab:cd:ef"
              nullable: true
        volumes:
          type: array
          description: Volumes attached to the instance
          items:
            $ref: "#/components/schemas/VolumeMount"
        created_at:
          type: string
          format: date-time
          description: Creation timestamp (RFC3339)
          example: "2025-01-15T10:30:00Z"
        started_at:
          type: string
          format: date-time
          description: Start timestamp (RFC3339)
          example: "2025-01-15T10:30:05Z"
          nullable: true
        stopped_at:
          type: string
          format: date-time
          description: Stop timestamp (RFC3339)
          example: "2025-01-15T12:30:00Z"
          nullable: true
        has_snapshot:
          type: boolean
          description: Whether a snapshot exists for this instance
          example: false
    
    PathInfo:
      type: object
      required: [exists]
      properties:
        exists:
          type: boolean
          description: Whether the path exists
          example: true
        is_dir:
          type: boolean
          description: True if this is a directory
          example: false
        is_file:
          type: boolean
          description: True if this is a regular file
          example: true
        is_symlink:
          type: boolean
          description: True if this is a symbolic link (only set when follow_links=false)
          example: false
        link_target:
          type: string
          description: Symlink target path (only set when is_symlink=true)
          nullable: true
          example: "/actual/target/path"
        mode:
          type: integer
          description: File mode (Unix permissions)
          example: 420
        size:
          type: integer
          format: int64
          description: File size in bytes
          example: 1024
        error:
          type: string
          description: Error message if stat failed (e.g., permission denied). Only set when exists is false due to an error rather than the path not existing.
          nullable: true
          example: "permission denied"
    
    CreateImageRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          description: OCI image reference (e.g., docker.io/library/nginx:latest)
          example: docker.io/library/nginx:latest
    
    Image:
      type: object
      required: [name, digest, status, created_at]
      properties:
        name:
          type: string
          description: Normalized OCI image reference (tag or digest)
          example: docker.io/library/nginx:latest
        digest:
          type: string
          description: Resolved manifest digest
          example: sha256:abc123def456...
        status:
          type: string
          enum: [pending, pulling, converting, ready, failed]
          description: Build status
          example: ready
        queue_position:
          type: integer
          description: Position in build queue (null if not queued)
          example: 2
          nullable: true
        error:
          type: string
          description: Error message if status is failed
          example: "pull failed: connection timeout"
          nullable: true
        size_bytes:
          type: integer
          format: int64
          description: Disk size in bytes (null until ready)
          example: 536870912
          nullable: true
        entrypoint:
          type: array
          items:
            type: string
          description: Entrypoint from container metadata
          example: ["/docker-entrypoint.sh"]
          nullable: true
        cmd:
          type: array
          items:
            type: string
          description: CMD from container metadata
          example: ["nginx", "-g", "daemon off;"]
          nullable: true
        env:
          type: object
          additionalProperties:
            type: string
          description: Environment variables from container metadata
          example:
            PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        working_dir:
          type: string
          description: Working directory from container metadata
          example: /app
          nullable: true
        created_at:
          type: string
          format: date-time
          description: Creation timestamp (RFC3339)
          example: "2025-01-15T10:00:00Z"
    
    CreateVolumeRequest:
      type: object
      required: [name, size_gb]
      properties:
        id:
          type: string
          description: Optional custom identifier (auto-generated if not provided)
          example: vol-data-1
        name:
          type: string
          description: Volume name
          example: my-data-volume
        size_gb:
          type: integer
          description: Size in gigabytes
          example: 10
    
    VolumeAttachment:
      type: object
      required: [instance_id, mount_path, readonly]
      properties:
        instance_id:
          type: string
          description: ID of the instance this volume is attached to
          example: inst-abc123
        mount_path:
          type: string
          description: Mount path in the guest
          example: /mnt/data
        readonly:
          type: boolean
          description: Whether the attachment is read-only
          example: false
    
    Volume:
      type: object
      required: [id, name, size_gb, created_at]
      properties:
        id:
          type: string
          description: Unique identifier
          example: vol-data-1
        name:
          type: string
          description: Volume name
          example: my-data-volume
        size_gb:
          type: integer
          description: Size in gigabytes
          example: 10
        attachments:
          type: array
          description: List of current attachments (empty if not attached)
          items:
            $ref: "#/components/schemas/VolumeAttachment"
        created_at:
          type: string
          format: date-time
          description: Creation timestamp (RFC3339)
          example: "2025-01-15T09:00:00Z"
    
    AttachVolumeRequest:
      type: object
      required: [mount_path]
      properties:
        mount_path:
          type: string
          description: Path where volume should be mounted
          example: /mnt/data
        readonly:
          type: boolean
          description: Mount as read-only
          default: false

    Health:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [ok]
          example: ok
    
    IngressMatch:
      type: object
      required: [hostname]
      properties:
        hostname:
          type: string
          description: |
            Hostname to match. Can be:
            - Literal: "api.example.com" (exact match on Host header)
            - Pattern: "{instance}.example.com" (dynamic routing based on subdomain)
            
            Pattern hostnames use named captures in curly braces (e.g., {instance}, {app})
            that extract parts of the hostname for routing. The extracted values can be
            referenced in the target.instance field.
          example: "{instance}.example.com"
        port:
          type: integer
          description: Host port to listen on for this rule (default 80)
          default: 80
          example: 8080
    
    IngressTarget:
      type: object
      required: [instance, port]
      properties:
        instance:
          type: string
          description: |
            Target instance name, ID, or capture reference.
            - For literal hostnames: Use the instance name or ID directly (e.g., "my-api")
            - For pattern hostnames: Reference a capture from the hostname (e.g., "{instance}")
            
            When using pattern hostnames, the instance is resolved dynamically at request time.
          example: "{instance}"
        port:
          type: integer
          description: Target port on the instance
          example: 8080
    
    IngressRule:
      type: object
      required: [match, target]
      properties:
        match:
          $ref: "#/components/schemas/IngressMatch"
        target:
          $ref: "#/components/schemas/IngressTarget"
        tls:
          type: boolean
          description: Enable TLS termination (certificate auto-issued via ACME).
          default: false
        redirect_http:
          type: boolean
          description: Auto-create HTTP to HTTPS redirect for this hostname (only applies when tls is enabled)
          default: false
    
    CreateIngressRequest:
      type: object
      required: [name, rules]
      properties:
        name:
          type: string
          description: Human-readable name (lowercase letters, digits, and dashes only; cannot start or end with a dash)
          pattern: ^[a-z0-9]([a-z0-9-]*[a-z0-9])?$
          maxLength: 63
          example: my-api-ingress
        rules:
          type: array
          description: Routing rules for this ingress
          items:
            $ref: "#/components/schemas/IngressRule"
          minItems: 1
    
    Ingress:
      type: object
      required: [id, name, rules, created_at]
      properties:
        id:
          type: string
          description: Auto-generated unique identifier
          example: 2OgJqXsP7j1qLVVYvGJDNiYVlPO
        name:
          type: string
          description: Human-readable name
          example: my-api-ingress
        rules:
          type: array
          description: Routing rules for this ingress
          items:
            $ref: "#/components/schemas/IngressRule"
        created_at:
          type: string
          format: date-time
          description: Creation timestamp (RFC3339)
          example: "2025-01-15T10:00:00Z"

    DeviceType:
      type: string
      enum: [gpu, pci]
      description: Type of PCI device
    
    CreateDeviceRequest:
      type: object
      required: [pci_address]
      properties:
        name:
          type: string
          description: Optional globally unique device name. If not provided, a name is auto-generated from the PCI address (e.g., "pci-0000-a2-00-0")
          pattern: ^[a-zA-Z0-9][a-zA-Z0-9_.-]+$
          example: l4-gpu
        pci_address:
          type: string
          description: PCI address of the device (required, e.g., "0000:a2:00.0")
          example: "0000:a2:00.0"
    
    Device:
      type: object
      required: [id, type, pci_address, vendor_id, device_id, iommu_group, bound_to_vfio, created_at]
      properties:
        id:
          type: string
          description: Auto-generated unique identifier (CUID2 format)
          example: tz4a98xxat96iws9zmbrgj3a
        name:
          type: string
          description: Device name (user-provided or auto-generated from PCI address)
          example: l4-gpu
        type:
          $ref: "#/components/schemas/DeviceType"
        pci_address:
          type: string
          description: PCI address
          example: "0000:a2:00.0"
        vendor_id:
          type: string
          description: PCI vendor ID (hex)
          example: "10de"
        device_id:
          type: string
          description: PCI device ID (hex)
          example: "27b8"
        iommu_group:
          type: integer
          description: IOMMU group number
          example: 82
        bound_to_vfio:
          type: boolean
          description: |
            Whether the device is currently bound to the vfio-pci driver, which is required for VM passthrough.
            - true: Device is bound to vfio-pci and ready for (or currently in use by) a VM. The device's native driver has been unloaded.
            - false: Device is using its native driver (e.g., nvidia) or no driver. Hypeman will automatically bind to vfio-pci when attaching to an instance.
          example: false
        attached_to:
          type: string
          description: Instance ID if attached
          nullable: true
          example: null
        created_at:
          type: string
          format: date-time
          description: Registration timestamp (RFC3339)
          example: "2025-01-15T10:00:00Z"
    
    AvailableDevice:
      type: object
      required: [pci_address, vendor_id, device_id, iommu_group]
      properties:
        pci_address:
          type: string
          description: PCI address
          example: "0000:a2:00.0"
        vendor_id:
          type: string
          description: PCI vendor ID (hex)
          example: "10de"
        device_id:
          type: string
          description: PCI device ID (hex)
          example: "27b8"
        vendor_name:
          type: string
          description: Human-readable vendor name
          example: "NVIDIA Corporation"
        device_name:
          type: string
          description: Human-readable device name
          example: "L4"
        iommu_group:
          type: integer
          description: IOMMU group number
          example: 82
        current_driver:
          type: string
          description: Currently bound driver (null if none)
          nullable: true
          example: "nvidia"

paths:
  /health:
    get:
      summary: Health check
      operationId: getHealth
      responses:
        200:
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Health"
  
  
  /images:
    get:
      summary: List images
      operationId: listImages
      security:
        - bearerAuth: []
      responses:
        200:
          description: List of images
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Image"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Pull and convert OCI image
      operationId: createImage
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateImageRequest"
      responses:
        202:
          description: Image build started (async)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Image"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        404:
          description: Image not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /images/{name}:
    get:
      summary: Get image details
      operationId: getImage
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: URL-encoded image name (e.g. docker.io%2Flibrary%2Falpine%3Alatest)
      responses:
        200:
          description: Image details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Image"
        404:
          description: Image not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Delete image
      operationId: deleteImage
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: URL-encoded image name
      responses:
        204:
          description: Image deleted
        404:
          description: Image not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances:
    get:
      summary: List instances
      operationId: listInstances
      security:
        - bearerAuth: []
      responses:
        200:
          description: List of instances
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Instance"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create and start instance
      operationId: createInstance
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateInstanceRequest"
      responses:
        201:
          description: Instance created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}:
    get:
      summary: Get instance details
      operationId: getInstance
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Instance ID or name
      responses:
        200:
          description: Instance details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Stop and delete instance
      operationId: deleteInstance
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Instance ID or name
      responses:
        204:
          description: Instance deleted
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}/standby:
    post:
      summary: Put instance in standby (pause, snapshot, delete VMM)
      operationId: standbyInstance
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Instance ID or name
      responses:
        200:
          description: Instance in standby
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - instance not in correct state
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}/restore:
    post:
      summary: Restore instance from standby
      operationId: restoreInstance
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Instance ID or name
      responses:
        200:
          description: Instance restored
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - instance not in standby or no snapshot
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}/stop:
    post:
      summary: Stop instance (graceful shutdown)
      operationId: stopInstance
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Instance ID or name
      responses:
        200:
          description: Instance stopped
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - instance not in correct state
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}/start:
    post:
      summary: Start a stopped instance
      operationId: startInstance
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Instance ID or name
      responses:
        200:
          description: Instance started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - instance not in stopped state
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}/logs:
    get:
      summary: Stream instance logs (SSE)
      description: |
        Streams instance logs as Server-Sent Events.
        Use the `source` parameter to select which log to stream:
        - `app` (default): Guest application logs (serial console)
        - `vmm`: Cloud Hypervisor VMM logs
        - `hypeman`: Hypeman operations log
        
        Returns the last N lines (controlled by `tail` parameter), then optionally
        continues streaming new lines if `follow=true`.
      operationId: getInstanceLogs
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Instance ID or name
        - name: tail
          in: query
          required: false
          schema:
            type: integer
            default: 100
          description: Number of lines to return from end
        - name: follow
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Continue streaming new lines after initial output
        - name: source
          in: query
          required: false
          schema:
            type: string
            enum: [app, vmm, hypeman]
            default: app
          description: |
            Log source to stream:
            - app: Guest application logs (serial console output)
            - vmm: Cloud Hypervisor VMM logs (hypervisor stdout+stderr)
            - hypeman: Hypeman operations log (actions taken on this instance)
      responses:
        200:
          description: Log stream (SSE)
          content:
            text/event-stream:
              schema:
                type: string
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}/stat:
    get:
      summary: Get filesystem path info
      description: |
        Returns information about a path in the guest filesystem.
        Useful for checking if a path exists, its type, and permissions
        before performing file operations.
      operationId: statInstancePath
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Instance ID or name
        - name: path
          in: query
          required: true
          schema:
            type: string
          description: Path to stat in the guest filesystem
          example: "/app/data"
        - name: follow_links
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Follow symbolic links (like stat vs lstat)
      responses:
        200:
          description: Path information
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PathInfo"
        404:
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Instance not in running state
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /instances/{id}/volumes/{volumeId}:
    post:
      summary: Attach volume to instance
      operationId: attachVolume
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Instance ID or name
        - name: volumeId
          in: path
          required: true
          schema:
            type: string
          description: Volume ID or name
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AttachVolumeRequest"
      responses:
        200:
          description: Volume attached
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        404:
          description: Instance or volume not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - volume already attached
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Detach volume from instance
      operationId: detachVolume
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Instance ID or name
        - name: volumeId
          in: path
          required: true
          schema:
            type: string
          description: Volume ID or name
      responses:
        200:
          description: Volume detached
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Instance"
        404:
          description: Instance or volume not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /volumes:
    get:
      summary: List volumes
      operationId: listVolumes
      security:
        - bearerAuth: []
      responses:
        200:
          description: List of volumes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Volume"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create volume
      description: |
        Creates a new volume. Supports two modes:
        - JSON body: Creates an empty volume of the specified size
        - Multipart form: Creates a volume pre-populated with content from a tar.gz archive
      operationId: createVolume
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateVolumeRequest"
          multipart/form-data:
            schema:
              type: object
              required:
                - name
                - size_gb
                - content
              properties:
                name:
                  type: string
                  description: Volume name
                  example: my-data-volume
                size_gb:
                  type: integer
                  description: Maximum size in GB (extraction fails if content exceeds this)
                  example: 10
                id:
                  type: string
                  description: Optional custom volume ID (auto-generated if not provided)
                  example: vol-data-1
                content:
                  type: string
                  format: binary
                  description: tar.gz archive file containing the volume content
      responses:
        201:
          description: Volume created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Volume"
        400:
          description: Bad request (invalid data or archive too large)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - volume with this ID already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /volumes/{id}:
    get:
      summary: Get volume details
      operationId: getVolume
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Volume ID or name
      responses:
        200:
          description: Volume details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Volume"
        404:
          description: Volume not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Delete volume
      operationId: deleteVolume
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Volume ID or name
      responses:
        204:
          description: Volume deleted
        404:
          description: Volume not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - volume is attached
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /devices:
    get:
      summary: List registered devices
      operationId: listDevices
      security:
        - bearerAuth: []
      responses:
        200:
          description: List of registered devices
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Device"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Register a device for passthrough
      operationId: createDevice
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateDeviceRequest"
      responses:
        201:
          description: Device registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Device"
        400:
          description: Bad request (invalid name or PCI address)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        404:
          description: PCI device not found on host
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - device or name already registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /devices/available:
    get:
      summary: Discover passthrough-capable devices on host
      operationId: listAvailableDevices
      security:
        - bearerAuth: []
      responses:
        200:
          description: List of available PCI devices
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AvailableDevice"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /devices/{id}:
    get:
      summary: Get device details
      operationId: getDevice
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Device ID or name
      responses:
        200:
          description: Device details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Device"
        404:
          description: Device not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Unregister device
      operationId: deleteDevice
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Device ID or name
      responses:
        204:
          description: Device unregistered
        404:
          description: Device not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - device is attached to an instance
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /ingresses:
    get:
      summary: List ingresses
      operationId: listIngresses
      security:
        - bearerAuth: []
      responses:
        200:
          description: List of ingresses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Ingress"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      summary: Create ingress
      operationId: createIngress
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateIngressRequest"
      responses:
        201:
          description: Ingress created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ingress"
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        401:
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Conflict - ingress with this name already exists or hostname in use
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /ingresses/{id}:
    get:
      summary: Get ingress details
      operationId: getIngress
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Ingress ID, name, or ID prefix
      responses:
        200:
          description: Ingress details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ingress"
        404:
          description: Ingress not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Ambiguous identifier matches multiple ingresses
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      summary: Delete ingress
      operationId: deleteIngress
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Ingress ID, name, or ID prefix
      responses:
        204:
          description: Ingress deleted
        404:
          description: Ingress not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        409:
          description: Ambiguous identifier matches multiple ingresses
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        500:
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"


